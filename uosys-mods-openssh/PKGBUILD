# Maintainer: tinywrkb <tinywrkb@gmail.com>

_pkgname=openssh
pkgname=uosys-mods-${_pkgname}
pkgver=2022.01.23.1
pkgrel=1
pkgdesc="$_pkgname uosys mods"
arch=('any')
license=('GPL')
url=''
depends=('uosys-mods')
source=('patch' 'ssh-agent.service')
sha256sums=('SKIP' 'SKIP')

build() {
  cat << EOF > mods
#target_list=()

mv_list=(ssh)

#rmdir_list=()

link_list=(ssh)
EOF

  cat << EOF > tmpfiles.d.conf
# $_pkgname
d /var/etc/ssh - - - - -
L+ /var/etc/ssh/moduli - - - - /usr/share/etc/ssh/moduli
L+ /var/etc/ssh/ssh_config - - - - /usr/share/etc/ssh/ssh_config
f /var/etc/ssh/ssh_known_hosts - - - - -
L- /var/etc/ssh/sshd_config - - - - /usr/share/etc/ssh/sshd_config
f /var/etc/ssh/sshd_config.local - - - - "# OpenSSH daemon local machine settings. For complete override, replace the sshd_config symlink"
EOF
}

package() {
  depends+=($_pkgname)
  source /usr/lib/os/os-mods-install

  install -dm755 -p ${pkgdir}/usr/lib/systemd/system/multi-user.target.wants
  ln -s -t ${pkgdir}/usr/lib/systemd/system/multi-user.target.wants/ \
    ../sshd.service

  install -Dm644 ssh-agent.service -t ${pkgdir}/usr/lib/systemd/user/
  install -dm755 ${pkgdir}/usr/lib/systemd/user/default.target.wants/
  ln -s -t ${pkgdir}/usr/lib/systemd/user/default.target.wants/ \
    ../ssh-agent.service
}
